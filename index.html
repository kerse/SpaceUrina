<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Показатели МКС: Ёмкость и сигнал</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      text-align: center;
      padding-top: 50px;
    }
    .container {
      display: inline-block;
      background: #fff;
      padding: 20px 40px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #value {
      font-size: 48px;
      color: #007BFF;
    }
    #signal {
      font-size: 24px;
      color: #555;
      margin-top: 10px;
    }
  </style>
  <!-- Подключаем UMD-сборку Lightstreamer Client Web -->
  <script src="https://unpkg.com/lightstreamer-client-web/lightstreamer.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Показатели МКС</h1>
    <div id="value">Загрузка данных...</div>
    <div id="signal">Сигнал: неизвестен</div>
  </div>

  <script>
    // Инициализация клиента с использованием защищённого WebSocket-соединения и завершающего слэша.
    var client = new LightstreamerClient("wss://push.lightstreamer.com/", "ISSLIVE");

    // Диагностический слушатель для отслеживания статуса клиента.
    client.addListener({
      onStatusChange: function(status) {
        console.log("Клиентский статус: " + status);
      },
      onServerError: function(code, message) {
        console.error("Ошибка сервера: " + code + " " + message);
      }
    });

    client.connect();

    // Подписка для обновлений ёмкости (NODE3000005)
    var pissTankSub = new Subscription("MERGE", ["NODE3000005"], ["Value", "Status", "TimeStamp"]);
    pissTankSub.addListener({
      onSubscribe: function() {
        console.log("Подписка на NODE3000005 началась");
      },
      onItemUpdate: function(update) {
        var value = update.getValue("Value");
        console.log("Получено обновление ёмкости: " + value);
        document.getElementById("value").textContent = value + "%";
      },
      onItemLostUpdates: function(itemName, lostUpdates) {
        console.warn("Потеря обновлений для " + itemName + ": " + lostUpdates);
      }
    });
    client.subscribe(pissTankSub);

    // Подписка для обновлений сигнала (TIME_000001)
    var signalSub = new Subscription("MERGE", ["TIME_000001"], ["TimeStamp", "Status.Class", "Status"]);
    signalSub.addListener({
      onSubscribe: function() {
        console.log("Подписка на TIME_000001 началась");
      },
      onItemUpdate: function(update) {
        var statusClass = update.getValue("Status.Class");
        console.log("Получено обновление сигнала: " + statusClass);
        var hasSignal = (statusClass === "24");
        document.getElementById("signal").textContent = "Сигнал: " + (hasSignal ? "есть" : "нет");
      }
    });
    client.subscribe(signalSub);
  </script>
</body>
</html>
